<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Orders • UniThrift</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111827;
      color: white;
      padding: 10px 16px;
    }
    .nav {
      max-width: 1040px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav a {
      color: #e5e7eb;
      text-decoration: none;
      font-size: 0.9rem;
      margin-right: 8px;
    }
    .nav a:hover {
      color: #ffffff;
    }
    .cart-link {
      margin-left: auto;
    }
    .badge {
      background: #f97316;
      color: white;
      border-radius: 999px;
      padding: 1px 7px;
      font-size: 0.7rem;
      margin-left: 4px;
    }
    main {
      max-width: 960px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.6rem;
    }
    .subtext {
      margin: 0 0 20px;
      font-size: 0.9rem;
      color: #6b7280;
    }
    .orders-list {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
    }
    .order-card {
      background: #ffffff;
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
      border: 1px solid #e5e7eb;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }
    .order-id {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .order-date {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .order-total {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 4px;
    }
    .order-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .order-items {
      font-size: 0.85rem;
      margin: 0;
      padding-left: 16px;
    }
    .empty-state {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 12px;
    }
    .pill-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #4338ca;
    }
    @media (max-width: 600px) {
      .nav {
        flex-wrap: wrap;
      }
      .cart-link {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav class="nav" aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="listings.html">Shop</a>
      <a href="my-orders.html" aria-current="page">My Orders</a>
      <a href="seller-dashboard.html">Sell</a>
      <a class="cart-link" href="cart.html" aria-label="Cart">
        Cart <span id="cartBadge" class="badge" style="display:none">0</span>
      </a>
      <a href="#" id="logoutLink">Logout</a>
    </nav>
  </header>

  <main>
    <h1>My Orders</h1>
    <p class="subtext">
      This page shows all orders you have placed using your UniThrift account.
    </p>
    <div id="ordersContainer" class="orders-list">
      <p id="ordersStatus" class="subtext">Loading your orders…</p>
    </div>
  </main>

  <script>
    const API_BASE = "https://group-final-project-production.up.railway.app";

    function getAuthToken() {
      try {
        return localStorage.getItem("authToken") || "";
      } catch {
        return "";
      }
    }

    function requireLogin() {
      const token = getAuthToken();
      if (!token) {
        window.location.href = "login.html";
      }
      return token;
    }

    function loadCart() {
      try {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      } catch {
        return [];
      }
    }

    function updateCartBadge() {
      const badge = document.getElementById("cartBadge");
      if (!badge) return;
      const cart = loadCart();
      const count = cart.reduce((sum, item) => sum + (Number(item.qty) || 1), 0);
      if (count > 0) {
        badge.textContent = count;
        badge.style.display = "inline-block";
      } else {
        badge.style.display = "none";
      }
    }

    function formatPeso(n) {
      n = Number(n) || 0;
      return "₱" + n.toLocaleString("en-PH", { maximumFractionDigits: 0 });
    }

    function formatDateTime(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString("en-PH", {
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    async function loadMyOrders() {
      const token = requireLogin();
      const container = document.getElementById("ordersContainer");
      const statusText = document.getElementById("ordersStatus");
      if (!container) return;

      try {
        const resp = await fetch(API_BASE + "/api/my/orders", {
          headers: {
            "Authorization": "Bearer " + token,
          },
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || "Failed to load your orders");
        }

        const orders = Array.isArray(data) ? data : (data.orders || []);

        if (!orders.length) {
          container.innerHTML = '<p class="empty-state">You have not placed any orders yet.</p>';
          return;
        }

        container.innerHTML = "";
        orders.forEach((o) => {
          const card = document.createElement("article");
          card.className = "order-card";

          const when = formatDateTime(o.createdAt);
          const total = formatPeso(o.total || 0);
          const discount = o.discount ? formatPeso(o.discount) : null;
          const coupon = o.couponCode || null;
          const campus = o.campus || "N/A";

          const items = (o.items || []).map(it => {
            const qty = Number(it.qty) || 1;
            const label = it.productId || it.name || "Item";
            return qty + "× " + label;
          });

          card.innerHTML = `
            <div class="order-header">
              <div>
                <div class="order-id">Order #${o.id}</div>
                <div class="order-date">${when}</div>
              </div>
              <div>
                <span class="pill-status">Placed</span>
              </div>
            </div>
            <div class="order-total">${total}</div>
            <div class="order-meta">
              Campus: ${campus}
              ${coupon ? ` • Coupon: ${coupon}` : ""}
              ${discount ? ` • Discount: ${discount}` : ""}
            </div>
            <div class="order-meta">
              Items:
            </div>
            <ul class="order-items">
              ${items.map(li => `<li>${li}</li>`).join("")}
            </ul>
          `;
          container.appendChild(card);
        });
      } catch (e) {
        console.error(e);
        if (statusText) {
          statusText.textContent = "Failed to load your orders. Please try again.";
        } else {
          container.innerHTML = '<p class="empty-state">Failed to load your orders.</p>';
        }
      }
    }

    // Logout handler
    const logoutBtn = document.getElementById("logoutLink");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function (e) {
        e.preventDefault();
        localStorage.removeItem("authToken");
        localStorage.removeItem("authUser");
        window.location.href = "login.html";
      });
    }

    // Init
    updateCartBadge();
    loadMyOrders();

    // keep badge in sync between tabs
    window.addEventListener("storage", function (ev) {
      if (ev.key === "cart") updateCartBadge();
    });
  </script>
</body>
</html>