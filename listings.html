<!DOCTYPE html>
<html lang="en">
<head>
<!-- SEO meta tags -->
<meta name="description" content="UniThrift is a student marketplace for buying and selling preloved items safely near your campus.">
<meta name="keywords" content="UniThrift, student marketplace, preloved items, Ateneo, campus shop">
<meta name="author" content="Group 3 - UniThrift">

<!-- Open Graph (for social media preview) -->
<meta property="og:title" content="UniThrift – Buy & Sell Preloved Campus Items">
<meta property="og:description" content="Find trusted sellers and affordable preloved goods near your university.">
<meta property="og:image" content="https://unithrift.netlify.app/preview.png">
<meta property="og:url" content="https://unithrift.netlify.app/">

<!-- Mobile-friendly -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">


  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UniThrift • Listings</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:16px; padding:16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .card img { width:100%; height:140px; object-fit:cover; border-radius:8px; }
    .price { font-weight:800; }
    .toolbar { display:flex; gap:8px; align-items:center; padding:12px 16px; }
    .badge { position:relative; top:-1px; margin-left:4px; font-size:12px; background:#16a34a; color:#fff; padding:2px 6px; border-radius:999px; }
  </style>
</head>
<body>
  <header style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;border-bottom:1px solid #eee">
    <a href="index.html" style="font-weight:800;text-decoration:none;color:#1e3a8a">UniThrift</a>
    <nav>
      <a href="index.html">Home</a>
      <a href="listings.html">Shop</a>
      <a href="my-orders.html">My Orders</a>
      <a href="seller-dashboard.html">Sell</a>
      <a href="cart.html">
        Cart <span id="cartBadge" class="badge" style="display:none">0</span>
      </a>
    </nav>
  </header>

  <div class="toolbar">
    <strong id="title">All Items</strong>
    <span id="activeFilters" style="color:#6b7280"></span>
  </div>

  <main class="grid" id="grid"></main>

  <script>
    const API_BASE = "http://localhost:8000";

    // will be filled from backend
    let products = [];

    const params = new URLSearchParams(location.search);
    const campus = params.get("campus");
    const category = params.get("category");
    const priceMin = Number(params.get("priceMin")) || 0;
    const priceMax = Number(params.get("priceMax")) || Infinity;

    function formatPeso(n) {
      return `₱${n.toFixed(0)}`;
    }

    function filterProducts(list) {
      return list.filter(p =>
        true &&
        (!category || p.category === category) &&
        (p.price >= priceMin && p.price <= priceMax)
      );
    }
  
    // ---------- CART HELPERS (standard: qty) ----------
    function loadCart() {
      try {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      } catch {
        return [];
      }
    }
  
    function saveCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }
  
    function updateCartBadge() {
      const badge = document.getElementById("cartBadge");
      if (!badge) return;
  
      const cart = loadCart();
      const totalQty = cart.reduce((n, i) => n + (i.qty || 1), 0);
  
      if (totalQty > 0) {
        badge.textContent = totalQty;
        badge.style.display = "inline-block";
      } else {
        badge.style.display = "none";
      }
    }
  
    function addToCartFromButton(btn) {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const price = Number(btn.dataset.price) || 0;
  
      let cart = loadCart();
      const existing = cart.find(i => i.id === id);
  
      if (existing) {
        existing.qty = (existing.qty || 1) + 1;
      } else {
        cart.push({
          id,
          name,
          price,
          qty: 1
        });
      }
  
      saveCart(cart);
      updateCartBadge();
      alert("Added to cart!");
    }
  
    function renderGrid(list) {
      const el = document.getElementById("grid");
      el.innerHTML = "";

      if (!list.length) {
        el.innerHTML =
          '<p style="color:#6b7280">No listings found for this filter.</p>';
        return;
      }

      list.forEach((p) => {
        const card = document.createElement("div");
        card.className = "card";

        const imgSrc = p.image || p.imageUrl || "placeholder.jpg";

        card.innerHTML = `
          <img loading="lazy" src="${imgSrc}" alt="${p.name}" />
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">${p.name}</div>
              <div class="price">₱${Number(p.price || 0).toFixed(0)}</div>
              <div style="font-size:0.85rem;color:#6b7280">
                ${(p.campus || "").toString()} • ${(p.category || "").toString()}
              </div>
            </div>
            <button
              class="addBtn"
              data-id="${p.id}"
              data-name="${p.name}"
              data-price="${p.price}"
            >
              Add to cart
            </button>
          </div>
        `;

        el.appendChild(card);
      });

      el.querySelectorAll(".addBtn").forEach((btn) => {
        btn.addEventListener("click", () => {
          addToCartFromButton(btn);
        });
      });
    }
  
    function updateHeader() {
      const t = document.getElementById("title");
      const f = document.getElementById("activeFilters");
      const parts = [];
  
      if (campus) parts.push(campus);
      if (category) parts.push(category);
      if (priceMin || priceMax !== Infinity) {
        const min = priceMin || 0;
        const max = priceMax === Infinity ? "∞" : priceMax;
        parts.push(`₱${min}–₱${max}`);
      }
  
      t.textContent = parts.length ? parts.join(" • ") : "All Items";
      f.textContent = parts.length ? "(filtered)" : "";
    }
  
    async function loadProductsFromApi() {
      try {
        const resp = await fetch(`${API_BASE}/api/products`);
        const data = await resp.json();
        products = Array.isArray(data) ? data : [];
        renderGrid(filterProducts(products));
      } catch (e) {
        console.error(e);
        document.getElementById("grid").innerHTML =
          '<p style="color:#6b7280">Could not load listings. Please try again later.</p>';
      }
    }

    updateHeader();
    loadProductsFromApi();
    updateCartBadge();
    window.addEventListener("storage", updateCartBadge);
  </script>
</body>
</html>
